<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic,900" rel="stylesheet" type="text/css">

<style> /* set the CSS */
body, svg{
  font-family: Lato;
  color: #353535;
}
#dummy{
  position: fixed;
  top: -100px;
  left: -100px;
  font-size: 22px;
  font-weight: bold;
}
#figureTitle{
    font-size: 22px;
    margin-top: 5px;
    margin-bottom: 21px;
    font-weight: bold;
}
#mapLegend{
right: calc(50% + -370px);
    position: absolute;
    top: calc(50% + -257px);
    width: 240px;
}
#ml-title{
font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
}
.ml-item{
    width: 38px;
    height: 18px;
    display: inline-block;
}
.ml-label{
  font-size: 12px;
  position: relative;
  top: 20px;
  left: -6px;
}
#map-container{
  margin-bottom: 50px;
}
#map-container svg{
    position: absolute;
    top: 32px;
    z-index: 100;
    left: 150px;
}
.axis text{
  font-size: 14px;
}
.y.axis path{
  display: none;
}
.y.axis line{
  stroke: #dedddd;
}
.tooltip-container{
    left: 0px;
    position: relative;
    display: inline-block;
    margin-right: 31px;
    top: 96px;
    z-index: 1000;
}
/* class applies to select element itself, not a wrapper element */
.select-css {
    font-family: Lato;
    color: #1696d2;
    line-height: 1.3;
    width: 109.6px;
    max-width: 100%; /* useful when width is set to anything other than 100% */
    box-sizing: border-box;
    margin: 0;
    border: 1px solid #d2d2d2;
    box-shadow: 0 1px 0 1px rgba(0,0,0,.04);
    border-radius: 0em;
    -moz-appearance: none;
    -webkit-appearance: none;
    appearance: none;
    background-color: #fff;
    display: inline-block;
    font-size: 22px;
    font-weight: bold;
    padding: 1px 10px;
    border: none;
    border-bottom: 3px dashed #1696d2;
    cursor: pointer;
    margin-right: 4px;
    /* note: bg image below uses 2 urls. The first is an svg data uri for the arrow icon, and the second is the gradient. 
        for the icon, if you want to change the color, be sure to use `%23` instead of `#`, since it's a url. You can also swap in a different svg icon or an external image reference
        
    */
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'),
      linear-gradient(to bottom, #ffffff 0%,#ffffff 100%);
    background-repeat: no-repeat, repeat;
    /* arrow icon position (1em from the right, 50% vertical) , then gradient position*/
    background-position: right .7em top 50%, 0 0;
    /* icon size, then gradient */
    background-size: .65em auto, 100%;
}
/* Hide arrow icon in IE browsers */
.select-css::-ms-expand {
    display: none;
}
/* Hover style */
.select-css:hover {
    border-color: #888;
}
/* Focus style */
.select-css:focus {
    border-color: #aaa;
    /* It'd be nice to use -webkit-focus-ring-color here but it doesn't work on box-shadow */
    box-shadow: 0 0 1px 3px rgba(59, 153, 252, .7);
    box-shadow: 0 0 0 3px -moz-mac-focusring;
    color: #222; 
    outline: none;
}

/* Set options to normal weight */
.select-css option {
    font-weight:normal;
}

/* Support for rtl text, explicit support for Arabic and Hebrew */
*[dir="rtl"] .select-css, :root:lang(ar) .select-css, :root:lang(iw) .select-css {
    background-position: left .7em top 50%, 0 0;
    padding: .6em .8em .5em 1.4em;
}

/* Disabled styles */
.select-css:disabled, .select-css[aria-disabled=true] {
    color: graytext;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22graytext%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'),
      linear-gradient(to bottom, #ffffff 0%,#e5e5e5 100%);
}

.select-css:disabled:hover, .select-css[aria-disabled=true] {
    border-color: #aaa;
}


path.state.highlight{
  stroke: #fdbf11 !important;
  stroke-width: 3px !important;
}

.state{
  cursor: pointer;
}
.line {
  fill: none;
  /*stroke: steelblue;*/
  stroke-width: 2px;
}
#covidLine{
  stroke: #fdbf11;
}
#r07Line{
  stroke: #353535;
}
#r01Line{
  stroke: #1696d2;
}
#r90Line{
  stroke: #55b748;
}
.state{
  cursor: pointer;
}

.tt-line{
  fill: none;
  stroke-width: 2px;
  stroke: #353535;
}
#tt-dot{
  stroke: #fdbf11;
  stroke-width: 2px;
  fill: #fff
}
  #tt-vertical{
    opacity: 0;
  }


#lineParent{
    position: relative;
    /*margin-top: 39%;*/
  }
.lineTt.y{
position: absolute;
    top: 0px;
    right: 0px;
    width: 190px;
    font-size: 14px;
    background: rgba(255,255,255,.8)
}
.lineTt.x{
    left: 0px;
    width: 190px;
    font-size: 14px;
}
.lineTt span{
  font-weight: 900;
  color: #1696d2;
}
.tt-row{
  margin-bottom: 5px;
}
.ll-item{
  display: inline-block;
  font-size: 14px;
  margin-right: 18px;
}
.ll-top span{
  width: 17px;
  height: 3px;
  background: black;
  /* content: "."; */
  display: inline-block;
  margin-right: 5px;
  position: relative;
  top: -3px;
}
.ll-top.r90 span{
  background: #55b748
}
.ll-top.r01 span{
  background: #1696d2
}
.ll-top.r07 span{
  background: #353535
}
.ll-top.covid span{
  background: #fdbf11
}
.ll-bottom{
  font-size: 12px;
  margin-top: 3px;
  color: #696969;
}
#yAxisLabel{
    font-size: 14px;
    font-style: italic;
    position: relative;
    top: 22px;
}
#xAxisLabel{
    left: calc(50% - 180px);
    top: -10px;
    font-size: 14px;
    font-style: italic;
    position: relative;
    width: fit-content;
}
.tt-tense, .tt-plural{
  font-weight: normal !important;
  color: #353535 !important;
}
#lineTitle{
font-size: 18px;
    margin-bottom: 17px;
}
#lineContainer svg{
  margin-top: 10px;
}
#isMobile, #isPhone{
  display: none;
}

#mapSource{
position: absolute;
    top: calc(50% - 177px);
    font-size: 13px;
    width: 360px;
    left: calc(50% - 263px);
}
#mapSource span{
  font-weight: bold;
}

@media(max-width: 900px){
  #isMobile{
    display: block;
  }
  #map-container svg{
    left: 190px;
  }
  #mapLegend{
    top: calc(50% + -277px);
  }
  #lineParent{
    /*margin-top: 33%;*/
  }
#mapSource {
    position: absolute;
    top: calc(50% - 195px);
    font-size: 13px;
    width: 319px;
    left: calc(50% - 195px);
}
}
@media(max-width: 768px){
  #isPhone{
    display: block;
  }
  #map-container{
        display: block;
    height: 200px;
    position: initial;
  }
  #map-container svg {
display: block;
    top: 0px;
    left: -10%;
    position: relative;
  }
  .tooltip-container{

    position: initial;
    margin-top: 11px;
  }
  #mapLegend{
display: block;
    position: absolute;
    top: 0px;
    left: 14px;
  }
  #lineParent{
    /*margin-top: 54%;*/
  }
  .lineTt.y{
    position: relative;
    height: 140px;    
    top: -54px !important;
    background: white;
  }
  #xAxisLabel {
    left: calc(50% - 105px);
    top: -70px;
  }
  #tt-vertical{
    opacity: 1;
  }
  #mapSource{
left: 14px;
    top: 0px;
    width: 470px;
  }
}
@media (max-width: 580px){
#lineParent {
    /*margin-top: 54%;*/
}
#lineTitle{
  margin-bottom: 0px;
}
.ll-item{
  margin-top: 9px;
}
}
@media(max-width: 480px){
  #mapSource{
    width: 280px;
  }
  #mapLegend{
    top: 48px;
  }
  }
@media(max-width: 340px){

  #mapSource{
    top: 28px;
  }
}

</style>
<body>

<div id = "allData"></div>
<div id = "containerWidth"></div>
<div id = "stateAbbr"></div>
<div id = "isMobile"></div>
<div id = "isPhone"></div>
<div id="graph-container" class="wrapper">

<div id = "lineParent">
  <div id = "figureTitle">
    <select class = "select-css">
          <option value = "US" id = "state-option_AL">All US</option>
          <option value = "AL" id = "state-option_AL">Alabama</option>
          <option value = "AK" id = "state-option_AK">Alaska</option>
          <option value = "AZ" id = "state-option_AZ">Arizona</option>
          <option value = "AR" id = "state-option_AR">Arkansas</option>
          <option value = "CA" id = "state-option_CA">California</option>
          <option value = "CO" id = "state-option_CO">Colorado</option>
          <option value = "CT" id = "state-option_CT">Connecticut</option>
          <option value = "DC" id = "state-option_DC">District of Columbia</option>
          <option value = "DE" id = "state-option_DE">Delaware</option>
          <option value = "FL" id = "state-option_FL">Florida</option>
          <option value = "GA" id = "state-option_GA">Georgia</option>
          <option value = "HI" id = "state-option_HI">Hawaii</option>
          <option value = "ID" id = "state-option_ID">Idaho</option>
          <option value = "IL" id = "state-option_IL">Illinois</option>
          <option value = "IN" id = "state-option_IN">Indiana</option>
          <option value = "IA" id = "state-option_IA">Iowa</option>
          <option value = "KS" id = "state-option_KS">Kansas</option>
          <option value = "KY" id = "state-option_KY">Kentucky</option>
          <option value = "LA" id = "state-option_LA">Louisiana</option>
          <option value = "ME" id = "state-option_ME">Maine</option>
          <option value = "MD" id = "state-option_MD">Maryland</option>
          <option value = "MA" id = "state-option_MA">Massachusetts</option>
          <option value = "MI" id = "state-option_MI">Michigan</option>
          <option value = "MN" id = "state-option_MN">Minnesota</option>
          <option value = "MS" id = "state-option_MS">Mississippi</option>
          <option value = "MO" id = "state-option_MO">Missouri</option>
          <option value = "MT" id = "state-option_MT">Montana</option>
          <option value = "NE" id = "state-option_NE">Nebraska</option>
          <option value = "NV" id = "state-option_NV">Nevada</option>
          <option value = "NH" id = "state-option_NH">New Hampshire</option>
          <option value = "NJ" id = "state-option_NJ">New Jersey</option>
          <option value = "NM" id = "state-option_NM">New Mexico</option>
          <option value = "NY" id = "state-option_NY">New York</option>
          <option value = "NC" id = "state-option_NC">North Carolina</option>
          <option value = "ND" id = "state-option_ND">North Dakota</option>
          <option value = "OH" id = "state-option_OH">Ohio</option>
          <option value = "OK" id = "state-option_OK">Oklahoma</option>
          <option value = "OR" id = "state-option_OR">Oregon</option>
          <option value = "PA" id = "state-option_PA">Pennsylvania</option>
          <option value = "RI" id = "state-option_RI">Rhode Island</option>
          <option value = "SC" id = "state-option_SC">South Carolina</option>
          <option value = "SD" id = "state-option_SD">South Dakota</option>
          <option value = "TN" id = "state-option_TN">Tennessee</option>
          <option value = "TX" id = "state-option_TX">Texas</option>
          <option value = "UT" id = "state-option_UT">Utah</option>
          <option value = "VT" id = "state-option_VT">Vermont</option>
          <option value = "VA" id = "state-option_VA">Virginia</option>
          <option value = "WA" id = "state-option_WA">Washington</option>
          <option value = "WV" id = "state-option_WV">West Virginia</option>
          <option value = "WI" id = "state-option_WI">Wisconsin</option>
          <option value = "WY" id = "state-option_WY">Wyoming</option>
    </select>
    Unemployment Insurance Claims as of <span id = "title-date"></span></div>
  <div id = "lineLegend">
    <div class = "ll-item">
      <div class = "ll-top r90"><span></span>1990 recession</div>
      <div class = "ll-bottom">Beginning 7/14/1990</div>
    </div>

    <div class = "ll-item">
      <div class = "ll-top r01"><span></span>2001 recession</div>
      <div class = "ll-bottom">Beginning 3/17/2001</div>
    </div>

    <div class = "ll-item">
      <div class = "ll-top r07"><span></span>Great Recession</div>
      <div class = "ll-bottom">Beginning 12/15/2007</div>
    </div>

    <div class = "ll-item">
      <div class = "ll-top covid"><span></span>COVID-19 pandemic</div>
      <div class = "ll-bottom">Beginning 3/14/2020</div>
    </div>
  </div>
  <div id = "yAxisLabel">Total Unemployment Insurance claims</div>
  <div id = "lineContainer"></div>
  <div id = "xAxisLabel">Weeks since the start of each recession</div>

  <div class = "lineTt y">
    <div class = "tt-row">
      <span class = "tt-claims"></span> claims <span class = "tt-tense">have</span> been filed in <span class = "tt-state">the United States</span> over <span class = "tt-weeks"></span> week<span class = "tt-plural">s</span>.
    </div>
    <div class = "tt-row intersect">
      That&rsquo;s <span class = "tt-"></span> about as many claims as there were at week <span class = "tt-equiv"></span> in the Great Recession.
    </div>
    <div class = "tt-row surpass">
      It only took <span class = "tt-surpass"></span> weeks for <span class = "tt-state">the United States</span> to surpass its total claims during the Great Recession
    </div>
  </div>
</div>

<script src="js/vendor/jquery-2.2.1.min.js"></script>
<script src="js/vendor/jquery-ui.min.js"></script>

<script src="js/vendor/d3.v5.min.js"></script>
<script type="text/javascript" src="js/vendor/pym.min.js"></script>

<script>




function IS_MOBILE(){
  return d3.select("#isMobile").style("display") == "block" && d3.select("#isPhone").style("display") == "none"
}
function IS_PHONE(){
  return d3.select("#isPhone").style("display") == "block"
}

/*  This visualization was made possible by modifying code provided by:

http://bl.ocks.org/michellechandra/0b2ce4923dc9b5809922 */


var lookityUppity = {"United States":"US","Alabama":"AL","Alaska":"AK","Arkansas":"AR","Arizona":"AZ","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","District of Columbia":"DC","Florida":"FL","Georgia":"GA","Hawaii":"HI","Iowa":"IA","Idaho":"ID","Illinois":"IL","Indiana":"IN","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Missouri":"MO","Mississippi":"MS","Montana":"MT","North Carolina":"NC","North Dakota":"ND","Nebraska":"NE","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","Nevada":"NV","New York":"NY","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Virginia":"VA","Vermont":"VT","Washington":"WA","Wisconsin":"WI","West Virginia":"WV","Wyoming":"WY"}

var lookityUppityRev = {"US": "All US","AL":"Alabama","AK":"Alaska","AR":"Arkansas","AZ":"Arizona","CA":"California","CO":"Colorado","CT":"Connecticut","DE":"Delaware","DC":"District of Columbia","FL":"Florida","GA":"Georgia","HI":"Hawaii","IA":"Iowa","ID":"Idaho","IL":"Illinois","IN":"Indiana","KS":"Kansas","KY":"Kentucky","LA":"Louisiana","ME":"Maine","MD":"Maryland","MA":"Massachusetts","MI":"Michigan","MN":"Minnesota","MO":"Missouri","MS":"Mississippi","MT":"Montana","NC":"North Carolina","ND":"North Dakota","NE":"Nebraska","NH":"New Hampshire","NJ":"New Jersey","NM":"New Mexico","NV":"Nevada","NY":"New York","OH":"Ohio","OK":"Oklahoma","OR":"Oregon","PA":"Pennsylvania","RI":"Rhode Island","SC":"South Carolina","SD":"South Dakota","TN":"Tennessee","TX":"Texas","UT":"Utah","VA":"Virginia","VT":"Vermont","WA":"Washington","WI":"Wisconsin","WV":"West Virginia","WY":"Wyoming"}

var WEEK_TOTAL = 81;


//Create SVG element and append map to the SVG

function getAllData(){
  return d3.select("#allData").datum()[0]
}
function getContainerWidth(){
  return d3.select("#containerWidth").datum()[0]
}
function getState(){
    return d3.select("#stateAbbr").datum()[0]
}



function drawChart(container_width){
  d3.select("#containerWidth").datum([container_width])

  $lineContainer = $("#lineContainer")
  $lineContainer.empty();



  var mr = (IS_PHONE()) ? 40: 210;
  var ml = (IS_PHONE()) ? 40 : 74;
  var mbExtra = (IS_PHONE()) ? 70 : 0
  var hScale = (IS_PHONE()) ? .7 : .5;

  // set the dimensions and margins of the graph
  var margin = {top: 20, right: mr, bottom: 30 + mbExtra, left: ml},
  width = container_width - margin.left - margin.right,
  height = container_width*hScale - margin.top - margin.bottom + mbExtra;



  // set the ranges
  var x = d3.scaleLinear().range([0, width]);
  var y = d3.scaleLinear().range([height, 0]);

  // define the 1st line
  var covidline = d3.line()
  .defined(function(d) {
  return typeof(d.covid) != "undefined";
  })
  .x(function(d) { return x(d.week); })
  .y(function(d) { return y(d.covid); });

  // define the 2nd line
  var r07Line = d3.line()
  .x(function(d) { if(typeof(d.recession_07) != "undefined") return x(d.week); })
  .y(function(d) { if(typeof(d.recession_07) != "undefined") return y(d.recession_07); });

  var r01Line = d3.line()
  .defined(function(d) {
  return typeof(d.recession_01) != "undefined";
  })
  .x(function(d) { if(typeof(d.recession_01) != "undefined") return x(d.week); })
  .y(function(d) { if(typeof(d.recession_01) != "undefined") return y(d.recession_01); });


  var r90Line = d3.line()
  .defined(function(d) {
  return typeof(d.recession_90) != "undefined";
  })
  .x(function(d) { if(typeof(d.recession_90) != "undefined") return x(d.week); })
  .y(function(d) { if(typeof(d.recession_90) != "undefined") return y(d.recession_90); });




  // append the svg obgect to the body of the page
  // appends a 'group' element to 'svg'
  // moves the 'group' element to the top left margin
  var svg = d3.select("#lineContainer").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom + 10)
  .append("g")
  .attr("id","lineG")
  .attr("transform",
  "translate(" + margin.left + "," + margin.top + ")");

  // Get the data
  function cleanVal(val){
  if(val == "") return undefined
  else return +val
  }
  d3.csv("data/ui-claims.csv", function(data) {

    d3.select("#allData").datum([data])

  // format the data
  data.forEach(function(d) {
  d.week = +d.week;
  d.covid =  cleanVal(d.covid);
  d.recession_07 = cleanVal(d.recession_07);
  d.recession_01 = cleanVal(d.recession_01);
  d.recession_90 = cleanVal(d.recession_90);
  })
  var datum = data.filter(function(d){ return d.state == "US"})

  // Scale the range of the data
  x.domain(d3.extent(datum, function(d) { return d.week; }));
  y.domain([0, d3.max(datum, function(d) {
  return d3.max([d.recession_07, d.covid, d.recession_90, d.recession_01]) * 1.2; })]);


  svg.append("g")
  .attr("class", "y axis")
  .call(d3.axisLeft(y).tickSize(-width)
    .tickFormat(function(t){
    // console.log(t);
    if(t == 0) return 0
    else return (d3.format(".0f")(t/1000000)) + "M"
    // return t*2;
    // d3.format(".2s")
    }
  ));

  // Add the X Axis
  svg.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x).tickValues([10,20,30,40,50,60,70,WEEK_TOTAL]));

  svg.append("path")
  // .data([data])
  .datum(datum)
  .attr("class", "line")
  .attr("id","r01Line")
  .attr("d", r01Line);


    svg.append("path")
  // .data([data])
  .datum(datum)
  .attr("class", "line")
  .attr("id","r90Line")
  .attr("d", r90Line);

  // Add the covidline path.


  // Add the r07Line path.
  svg.append("path")
  // .data([data])
  .datum(datum)
  .attr("class", "line")
  .attr("id","r07Line")
  .attr("d", r07Line);


  svg.append("path")
  .datum(datum)
  .attr("class", "line")
  .attr("id","covidLine")
  .attr("d", covidline);




  // Add the Y Axis




  var voronoi = d3.voronoi()
  .x(function(d) { return x(d.week); })
  .y(function(d) { return y(d.covid); })
  .extent([[0, 0], [width, height]]);

var vg = svg.append("g")
  .attr("id", "voronoiG")

vg.selectAll("path")
    .data(voronoi.polygons(datum.filter(function(d){ return typeof(d.covid) != 'undefined'}))) //Use vononoi() with your dataset inside
    .enter().append("path")
    .attr("d", function(d, i) {  return "M" + d.join("L") + "Z"; })
    .datum(function(d, i) { return d })
    //Give each cell a unique class where the unique part corresponds
    //to the circle classes
    // .attr("class", function(d,i) { return "voronoi " + d.CountryCode; })
    //.style("stroke", "#2074A0") //If you want to look at the cells
    .style("fill", "transparent")
    .style("stroke","none")
    .style("pointer-events", "all")
    .on("mouseover", function(d){
      showTooltip(d.data, datum, x, y, svg, width)
    })
vg.on("mouseout",  removeTooltip);


    svg.append("line")
      .attr("class", "tt-line")
      .attr("id", "tt-horizontal")
      .attr("stroke-dasharray", "4 4")
      .style("opacity", 0)

    svg.append("line")
      .attr("class", "tt-line")
      .attr("id", "tt-vertical")
      .attr("stroke-dasharray", "4 4")



    svg.append("circle")
      .attr("id", "tt-dot")
      .attr("r",6)
      .style("opacity", 0)

var cd = datum.filter(function(d){ return typeof(d.covid) != "undefined"})
showTooltip(cd[cd.length-1], datum, x, y, svg, width)

startDay = new Date("5/28/2020")
weeksOut = cd.length - 10

daysOut = startDay.getDate() + weeksOut*7
startDay.setDate(daysOut)

var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
d3.select("#title-date").text( months[startDay.getMonth()] + " " + startDay.getDate() + ", " + startDay.getFullYear() )





  });
}





function showTooltip(d, datum, x, y, svg, width, height){
  var comma = d3.format(",")
  var mult = d3.format(".1f")

  d3.select("#tt-dot")
    .style("opacity",1)
    .attr("cx", x(d.week))
    .attr("cy", y(d.covid))

// var testHorizontal = 
    // d3.selectAll(:)

    d3.selectAll(".tt-weeks").text(d.week)
    d3.selectAll(".tt-plural").text(function(){
      return (d.week == 1) ? "" : "s"
    })
    d3.selectAll(".tt-claims").text(comma(d.covid))
    d3.selectAll(".tt-mult").text(mult(d.covid/d.recession_07))

    if(typeof(datum[d.week]["covid"]) == "undefined"){ d3.selectAll(".tt-tense").text("have") }
    else{ d3.selectAll(".tt-tense").text("had") }



    var pathLength = d3.select("#r07Line").node().getTotalLength();

    var cx = x(d.week);
    var beginning = cx,
        end = pathLength,
        target;
    while (true) {
        target = Math.floor((beginning + end) / 2);
        pos = d3.select("#r07Line").node().getPointAtLength(target);
        if ((target === end || target === beginning) && pos.x !== cx) {
            break;
        }
        if (pos.x > cx) end = target;
        else if (pos.x < cx) beginning = target;
        else break; //position found
    }




    var cy = y(d.covid);
    var beginning2 = -cy,
        end2 = pathLength,
        target2;
    while (true) {
        target2 = Math.floor((beginning2 + end2) / 2);
        pos2 = d3.select("#r07Line").node().getPointAtLength(target2);
        if ((target2 === end2 || target2 === beginning2) && pos2.y !== cy) {
            break;
        }
        if (pos2.y < cy) end2 = target2;
        else if (pos2.y > cy) beginning2 = target2;
        else break; //position found
    }

var ttL, ttVal;
if(IS_PHONE()){
  ttVal = 190 + width - pos2.x
  console.log(ttVal)
  if(ttVal < 190) ttVal = 190
  if(ttVal > window.innerWidth - 20) ttVal = window.innerWidth - 20
  ttL = "calc(100% - " +  ttVal + "px)"
console.log(ttL)
}else{
  ttL = "inherit"
}

d3.select(".lineTt.y")
.style("opacity",1)
.transition()
.style("top", function(){
  var scootch = ((d.covid/y.domain()[1]) < .15) ? 45 : 116
  return (y(d.covid) + scootch) + "px"
})

.style("right", function(){
  return (width - pos2.x) + "px"
})
.style("left", ttL)






  //   var ptH = path_line_intersections(d3.select("#r07Line"), d3.select("#tt-horizontal"), 500)
  //   var ptV = path_line_intersections(d3.select("#r07Line"), d3.select("#tt-vertical"), 500)
  d3.select("#tt-horizontal")
    .attr("x1", x(d.week))
    .attr("x2" , pos2.x)
    .attr("y1", y(d.covid))
    .attr("y2", y(d.covid))
    .style("opacity",1)


  d3.select("#tt-vertical")
    .attr("x1", pos2.x)
    .attr("x2" , pos2.x)
    .attr("y1", y(d.covid))
    .attr("y2", y(0) + 300)




if(datum[WEEK_TOTAL - 1]["recession_07"] > d.covid){
  d3.select(".tt-row.intersect").style("display","block")
  d3.select(".tt-row.surpass").style("display","none")
  d3.select(".tt-equiv").text(Math.round(x.invert(pos2.x)))  
}else{
  d3.select(".tt-row.intersect").style("display","none")
  d3.select(".tt-row.surpass").style("display","block")
  for(var i = 0; i <= d.week; i++){
    if(datum[i]["covid"] < datum[WEEK_TOTAL - 1]["recession_07"]){
      continue
    }
    else{
      d3.select(".tt-surpass").text(i+1);
      break;
    }

  }
}
  // d3.select("#tt-vertical")
  //   .attr("x1", x(d.week))
  //   .attr("x2" ,x(d.week))
  //   .attr("y1", y(d.covid))
  //   .attr("y2", ptV[0].y)
  //   .style("opacity",1)

}

function updateChart(state){
    d3.select("#stateAbbr").datum([state])
state = state.replace("state","").replace("deselected","").replace("selected","").replace("highlight","").replace("clicked","").replace("undefined","").trim()

d3.selectAll(".tt-state")
  .text(function(){
    if(state == "US") return "the United States"
    else if(state == "DC") return "the District of Columbia"
    else return lookityUppityRev[state]
  })

d3.select("#title-state").text(function(){
  return (state == "US") ? "All US" : lookityUppityRev[state];
})


//   if(state != "US"){
  
//     d3.selectAll("path.state").classed("highlight", false).classed("clicked", false)
//     d3.select("path.state." + state)
//       .classed("highlight", true)
//       .classed("clicked", true)

//     d3.select("path.state." + state).node().parentNode.parentNode.appendChild(d3.select("path.state." + state).node().parentNode)
//   }

// $(".select-css").val(lookityUppityRev[state])

  var mr = (IS_PHONE()) ? 40: 210;
  var ml = (IS_PHONE()) ? 40: 74
  var mbExtra = (IS_PHONE()) ? 70 : 0
  var hScale = (IS_PHONE()) ? .7 : .5;


  var container_width = getContainerWidth()
  var margin = {top: 20, right: mr, bottom: 30 + mbExtra, left: ml},
  width = container_width - margin.left - margin.right,
  height = container_width*hScale - margin.top - margin.bottom + mbExtra;



  // set the ranges
  var x = d3.scaleLinear().range([0, width]);
  var y = d3.scaleLinear().range([height, 0]);


  var covidline = d3.line()
  .defined(function(d) {
  return typeof(d.covid) != "undefined";
  })
  .x(function(d) { return x(d.week); })
  .y(function(d) { return y(d.covid); });

  // define the 2nd line
  var r07Line = d3.line()
  .defined(function(d) {
  return typeof(d.recession_07) != "undefined";
  })
  .x(function(d) { if(typeof(d.recession_07) != "undefined") return x(d.week); })
  .y(function(d) { if(typeof(d.recession_07) != "undefined") return y(d.recession_07); });

  var r01Line = d3.line()
  .defined(function(d) {
  return typeof(d.recession_01) != "undefined";
  })
  .x(function(d) { if(typeof(d.recession_01) != "undefined") return x(d.week); })
  .y(function(d) { if(typeof(d.recession_01) != "undefined") return y(d.recession_01); });


  var r90Line = d3.line()
  .defined(function(d) {
  return typeof(d.recession_90) != "undefined";
  })
  .x(function(d) { if(typeof(d.recession_90) != "undefined") return x(d.week); })
  .y(function(d) { if(typeof(d.recession_90) != "undefined") return y(d.recession_90); });



  var data = getAllData()
    var datum = data.filter(function(d){ return d.state == state})


  // Scale the range of the data
  x.domain([0, WEEK_TOTAL]);
  y.domain([0, d3.max(datum, function(d) {
  return d3.max([d.recession_07, d.covid, d.recession_90, d.recession_01]) * 1.2; })]);
  d3.select("#covidLine")
  .datum(datum)
  .transition()
  .attr("d", covidline);

  d3.select("#r07Line")
  .datum(datum)
  .transition()
  .attr("d", r07Line)
  .on("end", function(){
    var cd = datum.filter(function(d){ return typeof(d.covid) != "undefined"})
showTooltip(cd[cd.length-1], datum, x, y, svg, width)

  });

  d3.select("#r01Line")
  .datum(datum)
  .transition()
  .attr("d", r01Line);


  d3.select("#r90Line")
  .datum(datum)
  .transition()
  .attr("d", r90Line);

  d3.select(".y.axis")
  .transition()
  .call(d3.axisLeft(y).tickSize(-width)
        // .ticks(5)
        .tickFormat(function(t){
    // console.log(t);
    // if(t == 0) return 0
    // else if(t < 1000000) return (d3.format(".2f")(t/1000000)) + "M"
    // else return (d3.format(".0f")(t/1000000)) + "M"
    // return t*2;
    return d3.format(".2s")(t)
    })
  );


d3.selectAll("#voronoiG").remove()
var svg = d3.select("#lineG")
  
  var voronoi = d3.voronoi()
  .x(function(d) { return x(d.week); })
  .y(function(d) { return y(d.covid); })
  .extent([[0, 0], [width, height]]);

var vg = svg.append("g")
  .attr("id", "voronoiG")


vg.selectAll("path")
    .data(voronoi.polygons(datum.filter(function(d){ return typeof(d.covid) != 'undefined'}))) //Use vononoi() with your dataset inside
    .enter().append("path")
    .attr("d", function(d, i) {  return "M" + d.join("L") + "Z"; })
    .datum(function(d, i) { return d })
    //Give each cell a unique class where the unique part corresponds
    //to the circle classes
    // .attr("class", function(d,i) { return "voronoi " + d.CountryCode; })
    //.style("stroke", "#2074A0") //If you want to look at the cells
    .style("fill", "transparent")
    // .style("stroke","none")
    .style("stroke","none")
    // .style("pointer-events", "all")
    .on("mouseover", function(d){
      showTooltip(d["data"], datum, x, y, svg, width,height)
    })

vg.on("mouseout", removeTooltip)




}
function removeTooltip(){
  // d3.select("#tt-vertical").style("opacity",0)
  // d3.select("#tt-horizontal").style("opacity",0)
  // d3.select("#tt-dot").style("opacity",0)
}


function drawFigure(container_width){
  drawChart(container_width)
  // updateChart(getState())
}

d3.select("#stateAbbr").datum(["US"])
d3.select(".select-css").on("change", function(){
  var dummy = d3.select("body").append("div").attr("id","dummy").text(lookityUppityRev[this.value])
  console.log(dummy.node().getBoundingClientRect().width + "px")
  d3.select(".select-css").style("width",(dummy.node().getBoundingClientRect().width + 50) + "px")
  updateChart(this.value)
})

var pymChild = new pym.Child({ renderCallback: drawFigure, polling: 500 });

</script>
</body>
